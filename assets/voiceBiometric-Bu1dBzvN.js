import{d as w}from"./firebaseConfig-oADvoGp-.js";import{getDoc as b,doc as V}from"https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";async function B(n=4e3){const e=document.getElementById("recordVoiceBtn"),o=document.getElementById("voiceStatus");try{let h=function(){if(i=requestAnimationFrame(h),s.getByteFrequencyData(l),c){c.clearRect(0,0,a.width,a.height);const f=a.width/l.length*2;let g=0;for(let u=0;u<l.length;u++){const y=l[u]/255*a.height;c.fillStyle="#00c6ff",c.fillRect(g,a.height-y,f,y),g+=f+1}}};e&&(e.classList.add("recording-active"),e.textContent="üéôÔ∏è Recording..."),o&&(o.textContent="Recording... please speak clearly.");const t=await navigator.mediaDevices.getUserMedia({audio:!0}),r=new AudioContext,m=r.createMediaStreamSource(t),s=r.createAnalyser();s.fftSize=256,m.connect(s);const l=new Uint8Array(s.frequencyBinCount),d=new MediaRecorder(t),v=[],a=document.getElementById("voiceCanvas"),c=a?a.getContext("2d"):null;let i;d.ondataavailable=f=>v.push(f.data),d.start(),h(),console.log("üéôÔ∏è Recording started...");const p=new Promise(f=>{d.onstop=()=>{cancelAnimationFrame(i);const g=new Blob(v,{type:"audio/webm"});t.getTracks().forEach(u=>u.stop()),r.close(),e&&(e.classList.remove("recording-active"),e.textContent="üéôÔ∏è Record Voice"),o&&(o.textContent="‚úÖ Recording saved."),console.log("‚úÖ Recording complete."),f(g)}});return setTimeout(()=>d.stop(),n),await p}catch(t){throw console.error("üé§ Microphone error:",t),o&&(o.textContent="‚ùå Microphone not available."),alert("‚ö†Ô∏è Microphone access denied or unavailable."),t}}function x(n){return Array.from({length:16},()=>Math.random())}async function k(n){console.log("üéôÔ∏è Starting voice verification for:",n),alert("üéß Please say your passphrase for voice verification.");try{const e=await B(4e3),o=x(e);try{const t=await fetch("http://localhost:8080/api/voice/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:n,vector:o})});if(t.ok)return(await t.json()).match?(console.log("‚úÖ Voice verified via backend."),!0):(console.log("‚ùå Voice mismatch via backend."),!1);throw new Error("Backend verification failed.")}catch(t){console.warn("‚ö†Ô∏è Backend verification unavailable, using local mock:",t.message);const r=await b(V(w,"voiceprints",n));if(!r.exists())return alert("‚ö†Ô∏è No voice data found for this user."),!1;const m=r.data().vector||[],s=m.reduce((c,i,h)=>c+i*o[h],0),l=Math.sqrt(m.reduce((c,i)=>c+i*i,0)),d=Math.sqrt(o.reduce((c,i)=>c+i*i,0)),a=s/(l*d)>.8;return console.log(a?"‚úÖ Voice verified locally":"‚ùå Voice mismatch locally"),a}}catch(e){return console.error("‚ùå Voice verification failed:",e),alert("‚ùå Voice verification failed: "+e.message),!1}}export{B as r,k as v};
